@using Microsoft.Extensions.Localization
@using MubeaSatinalmaPortal
@inject IStringLocalizer<SharedResources> Localizer

@{
    ViewData["Title"] = Localizer["CreateNewRequest"];
    var talepNo = ViewBag.TalepNo as string ?? "MPXXXXXXXX";
}

<style>
    .uppercase {
        text-transform: uppercase;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4">@talepNo @Localizer["PurchaseRequest"]</h2>

    <div class="card shadow p-4 mb-4">
        <h5 class="mb-3">@Localizer["BasicInformation"]</h5>

        <form method="post">
            <input type="hidden" name="TalepNo" value="@talepNo" />

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">@Localizer["Department"]</label>
                    <select class="form-select" name="DepartmanID" asp-items="ViewBag.DepartmanList">
                        <option value="">@Localizer["PleaseSelect"]</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">@Localizer["CostCenter"]</label>
                    <select class="form-select" name="CostCenterID" asp-items="ViewBag.CostCenterList">
                        <option value="">@Localizer["PleaseSelect"]</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">@Localizer["ServiceType"]</label>
                    <select class="form-select" name="HizmetID" asp-items="ViewBag.HizmetTipiList">
                        <option value="">@Localizer["PleaseSelect"]</option>
                    </select>
                </div>
            </div>

            <h5 class="mb-3">@Localizer["RequestLines"]</h5>

            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>@Localizer["RequestLine"]</th>
                            <th>@Localizer["Quantity"]</th>
                            <th>@Localizer["Unit"]</th>
                            <th>@Localizer["MaterialDescription"]</th>
                            <th>@Localizer["Reason"]</th>
                            <th>@Localizer["RecommendedSupplier"]</th>
                            <th>@Localizer["Price"]</th>
                            <th>@Localizer["Currency"]</th>
                            <th>@Localizer["SupplierProductCode"]</th>
                            <th>@Localizer["RequestType"]</th>
                            <th>@Localizer["RequirementDeadline"]</th>
                            <th>@Localizer["Requester"]</th>
                            <th class="text-center">@Localizer["Actions"]</th>
                        </tr>
                    </thead>

                    <tbody id="talepRowsBody">
                        <tr>
                            <td class="text-center talep-row-index">1</td>
                            <td>
                                <input type="number" step="0.01" class="form-control form-control-sm" name="TalepAdet" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TalepBirim" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TalepMalzeme" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TalepGerekce" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TavsiyeTedarikci" />
                            </td>
                            <td>
                                <input type="number" step="0.01" class="form-control form-control-sm" name="TalepFiyat" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="FiyatParaBirimi" placeholder="EUR, USD, TL" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TedarikciUrunKodu" />
                            </td>
                            <td>
                                <select class="form-select form-select-sm uppercase" name="TalepTipi">
                                    <option value="">@Localizer["PleaseSelect"]</option>
                                    <option value="YENİ">@Localizer["New"]</option>
                                    <option value="YEDEK">@Localizer["Spare"]</option>
                                </select>
                            </td>
                            <td>
                                <input type="date" class="form-control form-control-sm" name="TalepTermin" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TalepEdenKisi" />
                            </td>
                            <td class="text-center align-middle">
                                <button type="button"
                                        class="btn btn-outline-danger btn-sm talep-row-delete"
                                        onclick="removeTalepRow(this)">
                                    @Localizer["DeleteLine"]
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn btn-outline-primary btn-sm mb-4" onclick="addTalepRow()">
                + @Localizer["AddRequestLine"]
            </button>

            <hr class="my-4" />

            <div class="d-flex justify-content-between">
                <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">← @Localizer["BackToHome"]</a>
                <button type="submit" class="btn btn-primary">@Localizer["Save"]</button>
            </div>
        </form>
    </div>

    <div class="alert alert-info">
        <strong>@Localizer["Information"]:</strong> @Localizer["CreatePageInfo"]
        <ul>
            <li>@Localizer["CreatingRequest"] @talepNo.</li>
            <li>@Localizer["CanAddMultipleLines"]</li>
        </ul>
    </div>
</div>

@section Scripts {
    <script>
        // Lokalize edilen metinleri JSON olarak JS'e gömüyoruz
         const i18n = {
             requiredFieldsTitle: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["PleaseFillRequiredFields"].Value)),
             fillAllRequestLines: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["PleaseFillAllRequestLines"].Value)),
             department: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["Department"].Value)),
             costCenter: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["CostCenter"].Value)),
             serviceType: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["ServiceType"].Value))
         };

         // Büyük harf
         document.addEventListener("input", function (e) {
             if (e.target.classList.contains("uppercase")) {
                 e.target.value = e.target.value.toUpperCase();
             }
         });

         function addTalepRow() {
             var tbody = document.getElementById("talepRowsBody");
             var count = tbody.getElementsByTagName("tr").length + 1;

             var row = document.createElement("tr");

             row.innerHTML = `
                 <td class="text-center talep-row-index">${count}</td>
                 <td><input type="number" step="0.01" class="form-control form-control-sm" name="TalepAdet" /></td>
                 <td><input type="text" class="form-control form-control-sm uppercase" name="TalepBirim" /></td>
                 <td><input type="text" class="form-control form-control-sm uppercase" name="TalepMalzeme" /></td>
                 <td><input type="text" class="form-control form-control-sm uppercase" name="TalepGerekce" /></td>
                 <td><input type="text" class="form-control form-control-sm uppercase" name="TavsiyeTedarikci" /></td>
                 <td><input type="number" step="0.01" class="form-control form-control-sm" name="TalepFiyat" /></td>
                 <td><input type="text" class="form-control form-control-sm uppercase" name="FiyatParaBirimi" /></td>
                 <td><input type="text" class="form-control form-control-sm uppercase" name="TedarikciUrunKodu" /></td>
                 <td>
                     <select class="form-select form-select-sm uppercase" name="TalepTipi">
                         <option value="">@Localizer["PleaseSelect"]</option>
                         <option value="YENİ">@Localizer["New"]</option>
                         <option value="YEDEK">@Localizer["Spare"]</option>
                     </select>
                 </td>
                 <td><input type="date" class="form-control form-control-sm" name="TalepTermin" /></td>
                 <td><input type="text" class="form-control form-control-sm uppercase" name="TalepEdenKisi" /></td>
                 <td class="text-center align-middle">
                     <button type="button"
                             class="btn btn-outline-danger btn-sm talep-row-delete"
                             onclick="removeTalepRow(this)">
                         @Localizer["DeleteLine"]
                     </button>
                 </td>
             `;

             tbody.appendChild(row);
         }

         function removeTalepRow(button) {
             var tbody = document.getElementById("talepRowsBody");
             var rows = tbody.getElementsByTagName("tr");

             // Tek satır kaldıysa sadece alanları temizle
             if (rows.length === 1) {
                 var inputs = rows[0].querySelectorAll("input, select");
                 inputs.forEach(function (input) {
                     if (input.tagName.toLowerCase() === "select") {
                         input.selectedIndex = 0;
                     } else {
                         input.value = "";
                     }
                 });
                 return;
             }

             // Tıklanan satırı sil
             var row = button.closest("tr");
             if (row) {
                 row.remove();
             }

             // Satır numaralarını yeniden sırala
             var indexes = tbody.querySelectorAll(".talep-row-index");
             indexes.forEach(function (cell, index) {
                 cell.textContent = (index + 1).toString();
             });
         }

         document.addEventListener("DOMContentLoaded", function () {
             var form = document.querySelector("form");
             if (!form) return;

             function isEmpty(value) {
                 return value == null || value.toString().trim() === "";
             }

             form.addEventListener("submit", function (e) {
                 var eksikler = [];

                 var departman = form.querySelector('select[name="DepartmanID"]');
                 var costcenter = form.querySelector('select[name="CostCenterID"]');
                 var hizmet = form.querySelector('select[name="HizmetID"]');

                 // Eski is-invalid'ları temizle
                 [departman, costcenter, hizmet].forEach(function (el) {
                     if (el) el.classList.remove("is-invalid");
                 });
                 document.querySelectorAll('#talepRowsBody input, #talepRowsBody select')
                     .forEach(function (el) { el.classList.remove("is-invalid"); });

                 // Üst dropdown kontrolleri
                 if (departman && (departman.value === "" || departman.value === "0")) {
                     eksikler.push(i18n.department);
                     departman.classList.add("is-invalid");
                 }

                 if (costcenter && (costcenter.value === "" || costcenter.value === "0")) {
                     eksikler.push(i18n.costCenter);
                     costcenter.classList.add("is-invalid");
                 }

                 if (hizmet && (hizmet.value === "" || hizmet.value === "0")) {
                     eksikler.push(i18n.serviceType);
                     hizmet.classList.add("is-invalid");
                 }

                 // Satır detay kontrolleri
                 var tbody = document.getElementById("talepRowsBody");
                 var rows = tbody ? tbody.querySelectorAll("tr") : [];
                 var anyRowError = false;

                 rows.forEach(function (row) {
                     var adet = row.querySelector('input[name="TalepAdet"]');
                     var birim = row.querySelector('input[name="TalepBirim"]');
                     var malzeme = row.querySelector('input[name="TalepMalzeme"]');
                     var gerekce = row.querySelector('input[name="TalepGerekce"]');
                     var tedarikci = row.querySelector('input[name="TavsiyeTedarikci"]');
                     var fiyat = row.querySelector('input[name="TalepFiyat"]');
                     var parabirimi = row.querySelector('input[name="FiyatParaBirimi"]');
                     var urunkodu = row.querySelector('input[name="TedarikciUrunKodu"]');
                     var talepTipi = row.querySelector('select[name="TalepTipi"]');
                     var termin = row.querySelector('input[name="TalepTermin"]');
                     var talepEden = row.querySelector('input[name="TalepEdenKisi"]');

                     function markInvalid(el) {
                         if (!el) return;
                         el.classList.add("is-invalid");
                         anyRowError = true;
                     }

                     // Adet: boş veya 0 olmasın
                     if (!adet || isEmpty(adet.value) || isNaN(parseFloat(adet.value)) || parseFloat(adet.value) <= 0) {
                         markInvalid(adet);
                     }

                     if (!birim || isEmpty(birim.value)) markInvalid(birim);
                     if (!malzeme || isEmpty(malzeme.value)) markInvalid(malzeme);
                     if (!gerekce || isEmpty(gerekce.value)) markInvalid(gerekce);
                     if (!tedarikci || isEmpty(tedarikci.value)) markInvalid(tedarikci);

                     // Fiyat: boş veya 0 olmasın
                     if (!fiyat || isEmpty(fiyat.value) || isNaN(parseFloat(fiyat.value)) || parseFloat(fiyat.value) <= 0) {
                         markInvalid(fiyat);
                     }

                     if (!parabirimi || isEmpty(parabirimi.value)) markInvalid(parabirimi);
                     if (!urunkodu || isEmpty(urunkodu.value)) markInvalid(urunkodu);
                     if (!talepTipi || isEmpty(talepTipi.value)) markInvalid(talepTipi);
                     if (!termin || isEmpty(termin.value)) markInvalid(termin);
                     if (!talepEden || isEmpty(talepEden.value)) markInvalid(talepEden);
                 });

                 if (anyRowError) {
                     eksikler.push(i18n.fillAllRequestLines);
                 }

                 if (eksikler.length > 0) {
                     let msg = i18n.requiredFieldsTitle + ":\n\n";
                     eksikler.forEach(function (item) {
                         msg += "- " + item + "\n";
                     });

                     alert(msg);
                     e.preventDefault();
                     e.stopPropagation();
                 }
             });
         });
    </script>
}

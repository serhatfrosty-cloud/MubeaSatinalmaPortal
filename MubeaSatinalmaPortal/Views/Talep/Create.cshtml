@using Microsoft.Extensions.Localization
@using MubeaSatinalmaPortal
@inject IStringLocalizer<SharedResources> Localizer

@{
    ViewData["Title"] = Localizer["CreateNewRequest"];
    var talepNo = ViewBag.TalepNo as string ?? "MPXXXXXXXX";
}

<style>
    .uppercase {
        text-transform: uppercase;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4">@talepNo @Localizer["PurchaseRequest"]</h2>

    <div class="card shadow p-4 mb-4">
        <h5 class="mb-3">@Localizer["BasicInformation"]</h5>

        <form method="post">
            <input type="hidden" name="TalepNo" value="@talepNo" />

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">@Localizer["Department"]</label>
                    <select class="form-select" name="DepartmanID" asp-items="ViewBag.DepartmanList">
                        <option value="">@Localizer["PleaseSelect"]</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">@Localizer["CostCenter"]</label>
                    <select class="form-select" name="CostCenterID" asp-items="ViewBag.CostCenterList">
                        <option value="">@Localizer["PleaseSelect"]</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">@Localizer["ServiceType"]</label>
                    <select class="form-select" name="HizmetID" asp-items="ViewBag.HizmetTipiList">
                        <option value="">@Localizer["PleaseSelect"]</option>
                    </select>
                </div>
            </div>

            <h5 class="mb-3">@Localizer["RequestLines"]</h5>

            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>@Localizer["RequestLine"]</th>
                            <th>@Localizer["Quantity"]</th>
                            <th>@Localizer["Unit"]</th>
                            <th>@Localizer["MaterialDescription"]</th>
                            <th>@Localizer["Reason"]</th>
                            <th>@Localizer["RecommendedSupplier"]</th>
                            <th>@Localizer["Price"]</th>
                            <th>@Localizer["Currency"]</th>
                            <th>@Localizer["SupplierProductCode"]</th>
                            <th>@Localizer["RequestType"]</th>
                            <th>@Localizer["RequirementDeadline"]</th>
                            <th>@Localizer["Requester"]</th>
                        </tr>
                    </thead>

                    <tbody id="talepRowsBody">
                        <tr>
                            <td class="text-center talep-row-index">1</td>
                            <td>
                                <input type="number" step="0.01" class="form-control form-control-sm" name="TalepAdet" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TalepBirim" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TalepMalzeme" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TalepGerekce" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TavsiyeTedarikci" />
                            </td>
                            <td>
                                <input type="number" step="0.01" class="form-control form-control-sm" name="TalepFiyat" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="FiyatParaBirimi" placeholder="EUR, USD, TL" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TedarikciUrunKodu" />
                            </td>
                            <td>
                                <select class="form-select form-select-sm uppercase" name="TalepTipi">
                                    <option value="">@Localizer["PleaseSelect"]</option>
                                    <option value="YENİ">@Localizer["New"]</option>
                                    <option value="YEDEK">@Localizer["Spare"]</option>
                                </select>
                            </td>
                            <td>
                                <input type="date" class="form-control form-control-sm" name="TalepTermin" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm uppercase" name="TalepEdenKisi" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn btn-outline-primary btn-sm mb-4" onclick="addTalepRow()">
                + @Localizer["AddRequestLine"]
            </button>

            <hr class="my-4" />

            <div class="d-flex justify-content-between">
                <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">← @Localizer["BackToHome"]</a>
                <button type="submit" class="btn btn-primary">@Localizer["Save"]</button>
            </div>
        </form>
    </div>

    <div class="alert alert-info">
        <strong>@Localizer["Information"]:</strong> @Localizer["CreatePageInfo"]
        <ul>
            <li>@Localizer["CreatingRequest"] @talepNo.</li>
            <li>@Localizer["CanAddMultipleLines"]</li>
        </ul>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("input", function (e) {
            if (e.target.classList.contains("uppercase")) {
                e.target.value = e.target.value.toUpperCase();
            }
        });

        function addTalepRow() {
            var tbody = document.getElementById("talepRowsBody");
            var count = tbody.getElementsByTagName("tr").length + 1;

            var row = document.createElement("tr");

            row.innerHTML = `
                <td class="text-center talep-row-index">${count}</td>
                <td><input type="number" step="0.01" class="form-control form-control-sm" name="TalepAdet" /></td>
                <td><input type="text" class="form-control form-control-sm uppercase" name="TalepBirim" /></td>
                <td><input type="text" class="form-control form-control-sm uppercase" name="TalepMalzeme" /></td>
                <td><input type="text" class="form-control form-control-sm uppercase" name="TalepGerekce" /></td>
                <td><input type="text" class="form-control form-control-sm uppercase" name="TavsiyeTedarikci" /></td>
                <td><input type="number" step="0.01" class="form-control form-control-sm" name="TalepFiyat" /></td>
                <td><input type="text" class="form-control form-control-sm uppercase" name="FiyatParaBirimi" /></td>
                <td><input type="text" class="form-control form-control-sm uppercase" name="TedarikciUrunKodu" /></td>
                <td>
                    <select class="form-select form-select-sm uppercase" name="TalepTipi">
                        <option value="">@Localizer["PleaseSelect"]</option>
                        <option value="YENİ">@Localizer["New"]</option>
                        <option value="YEDEK">@Localizer["Spare"]</option>
                    </select>
                </td>
                <td><input type="date" class="form-control form-control-sm" name="TalepTermin" /></td>
                <td><input type="text" class="form-control form-control-sm uppercase" name="TalepEdenKisi" /></td>
            `;

            tbody.appendChild(row);
        }

        document.addEventListener("DOMContentLoaded", function () {
            var form = document.querySelector("form");
            if (!form) return;

            form.addEventListener("submit", function (e) {
                var eksikler = [];
                var departman = form.querySelector('select[name="DepartmanID"]');
                var costcenter = form.querySelector('select[name="CostCenterID"]');
                var hizmet = form.querySelector('select[name="HizmetID"]');

                [departman, costcenter, hizmet].forEach(function (el) {
                    if (el) el.classList.remove("is-invalid");
                });

                if (departman && (departman.value === "" || departman.value === "0")) {
                    eksikler.push("@Localizer["Department"]");
                    departman.classList.add("is-invalid");
                }

                if (costcenter && (costcenter.value === "" || costcenter.value === "0")) {
                    eksikler.push("@Localizer["CostCenter"]");
                    costcenter.classList.add("is-invalid");
                }

                if (hizmet && (hizmet.value === "" || hizmet.value === "0")) {
                    eksikler.push("@Localizer["ServiceType"]");
                    hizmet.classList.add("is-invalid");
                }

                if (eksikler.length > 0) {
                    var msg = "@Localizer["PleaseFillRequiredFields"]:\n\n";
                    for (var i = 0; i < eksikler.length; i++) {
                        msg += "- " + eksikler[i] + "\n";
                    }
                    alert(msg);
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        });
    </script>
}